!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.PusherPlatform=e():t.PusherPlatform=e()}(this,function(){return function(t){function e(r){if(n[r])return n[r].exports;var s=n[r]={exports:{},id:r,loaded:!1};return t[r].call(s.exports,s,s.exports,e),s.loaded=!0,s.exports}var n={};return e.m=t,e.c=n,e.p="",e(0)}([function(t,e){"use strict";function n(t){if(!t)throw Error("Assertion error")}function r(t){var e={};if(!t)return e;for(var n=t.split("\r\n"),r=0;r<n.length;r++){var s=n[r],o=s.indexOf(": ");if(o>0){var i=s.substring(0,o),a=s.substring(o+2);e[i]=a}}return e}function s(t){return atob(t.replace(/\-/g,"+").replace(/_/g,"/"))}var o,i=function(){function t(t){this.statusCode=t.status,this.headers=r(t.getAllResponseHeaders()),this.info=t.responseText}return t}();!function(t){t[t.UNSENT=0]="UNSENT",t[t.OPENED=1]="OPENED",t[t.HEADERS_RECEIVED=2]="HEADERS_RECEIVED",t[t.LOADING=3]="LOADING",t[t.DONE=4]="DONE"}(o||(o={}));var a;!function(t){t[t.UNOPENED=0]="UNOPENED",t[t.OPENING=1]="OPENING",t[t.OPEN=2]="OPEN",t[t.ENDING=3]="ENDING",t[t.ENDED=4]="ENDED"}(a||(a={}));var u=function(){function t(t,e){var r=this;this.xhr=t,this.options=e,this.state=a.UNOPENED,this.gotEOS=!1,this.lastNewlineIndex=0,this.xhr.onreadystatechange=function(){if(r.xhr.readyState===o.UNSENT||r.xhr.readyState===o.OPENED||r.xhr.readyState===o.HEADERS_RECEIVED)n(r.state===a.OPENING);else if(r.xhr.readyState===o.LOADING)if(n(r.state===a.OPENING||r.state===a.OPEN||r.state===a.ENDING),200===r.xhr.status){r.state===a.OPENING&&(r.state=a.OPEN,r.options.onOpen&&r.options.onOpen()),n(r.state===a.OPEN||r.state===a.ENDING);var e=r.onChunk();n(r.state===a.OPEN||r.state===a.ENDING),null!=e&&(r.xhr.abort(),r.state=a.ENDED,r.options.onError&&r.options.onError(e))}else n(r.state===a.OPENING);else if(r.xhr.readyState===o.DONE)if(200===r.xhr.status){r.state===a.OPENING&&(r.state=a.OPEN,r.options.onOpen&&r.options.onOpen()),n(r.state===a.OPEN||r.state===a.ENDING);var e=r.onChunk();null!==e&&void 0!==e?(r.state=a.ENDED,r.options.onError&&r.options.onError(e)):r.state!==a.ENDING?r.options.onError&&r.options.onError(new Error("HTTP response ended without receiving EOS message")):r.options.onEnd&&r.options.onEnd()}else n(r.state===a.OPENING||r.state==a.OPEN||r.state===a.ENDED),r.state===a.ENDED||r.options.onError&&r.options.onError(new Error(new i(t).toString()))}}return t.prototype.open=function(t){if(this.state!==a.UNOPENED)throw new Error("Called .open() on Subscription object in unexpected state: "+this.state);this.state=a.OPENING,t&&this.xhr.setRequestHeader("authorization","Bearer "+t),this.xhr.send()},t.prototype.onChunk=function(){n(this.state===a.OPEN);var t=this.xhr.responseText,e=t.lastIndexOf("\n");if(e>this.lastNewlineIndex){var r=t.slice(this.lastNewlineIndex,e).split("\n");this.lastNewlineIndex=e;for(var s=0,o=r;s<o.length;s++){var i=o[s];if(0!==i.length){var u=JSON.parse(i),p=this.onMessage(u);if(null!=p)return p}}}},t.prototype.onMessage=function(t){if(n(this.state===a.OPEN),this.gotEOS)return new Error("Got another message after EOS message");if(!Array.isArray(t))return new Error("Message is not an array");if(t.length<1)return new Error("Message is empty array");switch(t[0]){case 0:return null;case 1:return this.onEventMessage(t);case 255:return this.onEOSMessage(t);default:return new Error("Unknown Message: "+JSON.stringify(t))}},t.prototype.onEventMessage=function(t){if(n(this.state===a.OPEN),4!==t.length)return new Error("Event message has "+t.length+" elements (expected 4)");var e=(t[0],t[1]),r=t[2],s=t[3];return"string"!=typeof e?new Error("Invalid event ID in message: "+JSON.stringify(t)):"object"!=typeof r||Array.isArray(r)?new Error("Invalid event headers in message: "+JSON.stringify(t)):void(this.options.onEvent&&this.options.onEvent({eventId:e,headers:r,body:s}))},t.prototype.onEOSMessage=function(t){if(n(this.state===a.OPEN),4!==t.length)return new Error("EOS message has "+t.length+" elements (expected 4)");var e=(t[0],t[1]),r=t[2];t[3];return"number"!=typeof e?new Error("Invalid EOS Status Code"):"object"!=typeof r||Array.isArray(r)?new Error("Invalid EOS Headers"):void(this.state=a.ENDING)},t.prototype.unsubscribe=function(t){this.state=a.ENDED,this.xhr.abort(),t?this.options.onError&&this.options.onError(t):this.options.onEnd&&this.options.onEnd()},t}(),p=function(){function t(t){this.options=t;var e=t.cluster.replace(/\/$/,"");this.baseURL=(t.encrypted!==!1?"https":"http")+"://"+e,this.XMLHttpRequest=t.XMLHttpRequest||window.XMLHttpRequest}return t.prototype.request=function(t){var e=this.createXHR(this.baseURL,t);return new Promise(function(n,r){e.onreadystatechange=function(){4===e.readyState&&(200===e.status?n(e.responseText):r(new i(e)))},e.send(JSON.stringify(t.body))})},t.prototype.newSubscription=function(t){return new u(this.createXHR(this.baseURL,{method:"SUBSCRIBE",path:t.path,headers:t.headers,body:null}),t)},t.prototype.createXHR=function(t,e){var n=this.XMLHttpRequest,r=new n,s=e.path.replace(/^\/+/,""),o=t+"/"+s;r.open(e.method.toUpperCase(),o,!0),e.body&&r.setRequestHeader("content-type","application/json"),e.jwt&&r.setRequestHeader("authorization","Bearer "+e.jwt);for(var i in e.headers)r.setRequestHeader(i,e.headers[i]);return r},t}();e.BaseClient=p;var h=function(){function t(t){this.jwt=t}return t.prototype.authorize=function(){var t=this;return new Promise(function(e,n){e(t.jwt)})},t}();e.SimpleTokenAuthorizer=h;var c=function(){function t(t,e){this.authServerUrl=t,this.credentials=e,this.accessToken=null}return t.prototype.authorize=function(){var t=this;return new Promise(function(e,n){if(null!=t.accessToken&&Date.now()<1e3*JSON.parse(s(t.accessToken.split(".")[1])).exp)e(t.accessToken);else{var r=new XMLHttpRequest;r.onreadystatechange=function(){4===r.readyState&&(200<=r.status&&r.status<300?(t.accessToken=JSON.parse(r.responseText).access_token,e(t.accessToken)):n(new Error("Unexpected status code in response from auth server: "+r.status)))},r.open("POST",t.authServerUrl,!0),r.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),r.send("grant_type=client_credentials"+(t.credentials?"&credentials="+encodeURIComponent(t.credentials):""))}})},t}();e.AuthServerAuthorizer=c;var E=function(){function t(t,e){this.feedName=t,this.app=e}return t.prototype.subscribe=function(t){return this.app.subscribe({path:"feeds/"+this.feedName,headers:t.lastEventId?{"Last-Event-Id":t.lastEventId}:{},onOpen:t.onOpen,onEvent:t.onItem,onEnd:t.onEnd,onError:t.onError})},t.prototype.get=function(t){var e=this,n="feeds/"+this.feedName,r="",s=[];t&&t.fromId&&s.push("from_id="+t.fromId),t&&t.limit&&s.push("limit="+t.limit),s.length>0&&(r="?"+s.join("&"));var o=n+r;return new Promise(function(t,n){e.app.request({method:"GET",path:o}).then(function(e){try{t(JSON.parse(e))}catch(t){n(t)}}).catch(function(t){n(t)})})},t.prototype.append=function(t){var e="feeds/"+this.feedName;return this.app.request({method:"POST",path:e,body:{items:[t]}})},t}(),f=function(){function t(t){this.appId=t.appId,this.authorizer=t.authorizer,this.client=t.client||new p({cluster:t.cluster||"api.private-beta-1.pusherplatform.com",encrypted:t.encrypted})}return t.prototype.request=function(t){var e=this;return t.path=this.absPath(t.path),!t.jwt&&this.authorizer?this.authorizer.authorize().then(function(n){return e.client.request(Object.assign(t,{jwt:n}))}):this.client.request(t)},t.prototype.subscribe=function(t){t.path=this.absPath(t.path);var e=this.client.newSubscription(t);return t.jwt?e.open(t.jwt):this.authorizer?this.authorizer.authorize().then(function(t){e.open(t)}).catch(function(t){e.unsubscribe(t)}):e.open(null),e},t.prototype.feed=function(t){return new E(t,this)},t.prototype.absPath=function(t){return("/apps/"+this.appId+"/"+t).replace(/\/+/g,"/").replace(/\/+$/,"")},t}();e.App=f}])});