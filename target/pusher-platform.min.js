!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.PusherPlatform=e():t.PusherPlatform=e()}(this,function(){return function(t){function e(r){if(n[r])return n[r].exports;var o=n[r]={exports:{},id:r,loaded:!1};return t[r].call(o.exports,o,o.exports,e),o.loaded=!0,o.exports}var n={};return e.m=t,e.c=n,e.p="",e(0)}([function(t,e){"use strict";function n(t){var e={};if(!t)return e;for(var n=t.split("\r\n"),r=0;r<n.length;r++){var o=n[r],s=o.indexOf(": ");if(s>0){var i=o.substring(0,s),a=o.substring(s+2);e[i]=a}}return e}var r=function(){function t(t){this.statusCode=t.status,this.headers=n(t.getAllResponseHeaders()),this.info=t.responseText}return t}(),o=function(){function t(t,e){var n=this;this.xhr=t,this.options=e,this.gotEOS=!1,this.calledOnOpen=!1,this.lastNewlineIndex=0,this.xhr.onreadystatechange=function(){if(3===n.xhr.readyState){if(200===n.xhr.status){n.opened();var e=n.onChunk();null!=e&&(n.xhr.abort(),n.options.onError&&n.options.onError(e))}}else if(4===n.xhr.readyState)if(200===n.xhr.status){n.opened();var e=n.onChunk();null!==e&&void 0!=e?n.options.onError&&n.options.onError(e):n.gotEOS?n.options.onEnd&&n.options.onEnd():n.options.onError&&n.options.onError(new Error("HTTP response ended without receiving EOS message"))}else n.options.onError&&n.options.onError(new Error(new r(t).toString()))}}return t.prototype.opened=function(){this.calledOnOpen||(this.options.onOpen&&this.options.onOpen(),this.calledOnOpen=!0)},t.prototype.open=function(t){t&&this.xhr.setRequestHeader("authorization","JWT "+t),this.xhr.send()},t.prototype.onChunk=function(){var t=this.xhr.responseText,e=t.lastIndexOf("\n");if(e>this.lastNewlineIndex){var n=t.slice(this.lastNewlineIndex,e).split("\n");this.lastNewlineIndex=e;for(var r=0,o=n;r<o.length;r++){var s=o[r];if(0!==s.length){var i=JSON.parse(s),a=this.onMessage(i);if(null!=a)return a}}}},t.prototype.onMessage=function(t){if(this.gotEOS)return new Error("Got another message after EOS message");if(!Array.isArray(t))return new Error("Message is not an array");if(t.length<1)return new Error("Message is empty array");switch(t[0]){case 0:return null;case 1:return this.onEventMessage(t);case 255:return this.onEOSMessage(t);default:return new Error("Unknown Message: "+JSON.stringify(t))}},t.prototype.onEventMessage=function(t){if(4!==t.length)return new Error("Event message has "+t.length+" elements (expected 4)");var e=(t[0],t[1]),n=t[2],r=t[3];return"string"!=typeof e?new Error("Invalid event ID in message: "+JSON.stringify(t)):"object"!=typeof n||Array.isArray(n)?new Error("Invalid event headers in message: "+JSON.stringify(t)):void(this.options.onEvent&&this.options.onEvent({eventId:e,headers:n,body:r}))},t.prototype.onEOSMessage=function(t){if(4!==t.length)return new Error("EOS message has "+t.length+" elements (expected 4)");var e=(t[0],t[1]),n=t[2];t[3];return"number"!=typeof e?new Error("Invalid EOS Status Code"):"object"!=typeof n||Array.isArray(n)?new Error("Invalid EOS Headers"):void(this.gotEOS=!0)},t.prototype.abort=function(t){this.xhr.abort(),t?this.options.onError&&this.options.onError(t):this.options.onEnd&&this.options.onEnd()},t}(),s=function(){function t(t){this.options=t;var e=t.cluster.replace(/\/$/,"");this.baseURL=(t.encrypted!==!1?"https":"http")+"://"+e,this.XMLHttpRequest=t.XMLHttpRequest||window.XMLHttpRequest}return t.prototype.request=function(t){var e=this.createXHR(this.baseURL,t);return new Promise(function(n,o){e.onreadystatechange=function(){4===e.readyState&&(200===e.status?n(e.responseText):o(new r(e)))},e.send(JSON.stringify(t.body))})},t.prototype.newSubscription=function(t){return new o(this.createXHR(this.baseURL,{method:"SUBSCRIBE",path:t.path,headers:t.headers,body:null}),t)},t.prototype.createXHR=function(t,e){var n=this.XMLHttpRequest,r=new n,o=e.path.replace(/^\/+/,""),s=t+"/"+o;r.open(e.method.toUpperCase(),s,!0),e.body&&r.setRequestHeader("content-type","application/json");for(var i in e.headers)r.setRequestHeader(i,e.headers[i]);return r},t}();e.BaseClient=s;var i=function(){function t(t){this.jwt=t}return t.prototype.authorize=function(){var t=this;return new Promise(function(e,n){e(t.jwt)})},t}();e.SimpleTokenAuthorizer=i;var a=function(){function t(t,e){this.feedName=t,this.app=e}return t.prototype.subscribe=function(t){return this.app.subscribe({path:"feeds/"+this.feedName,headers:t.lastEventId?{"Last-Event-Id":t.lastEventId}:{},onOpen:t.onOpen,onEvent:t.onItem,onEnd:function(){t.onError(new Error("Unexpected end to Feed subscription"))},onError:t.onError})},t.prototype.append=function(t){var e="feeds/"+this.feedName;return this.app.request({method:"POST",path:e,body:{items:[t]}})},t}(),p=function(){function t(t){this.appId=t.appId,this.authorizer=t.authorizer,this.client=t.client||new s({cluster:t.cluster||"api.private-beta-1.pusherplatform.com",encrypted:t.encrypted})}return t.prototype.request=function(t){var e=this;return t.path=this.absPath(t.path),!t.jwt&&this.authorizer?this.authorizer.authorize().then(function(n){return e.client.request(Object.assign(t,{jwt:n}))}):this.client.request(t)},t.prototype.subscribe=function(t){t.path=this.absPath(t.path);var e=this.client.newSubscription(t);return t.jwt?e.open(t.jwt):this.authorizer?this.authorizer.authorize().then(function(t){e.open(t)}).catch(function(t){e.abort(t)}):e.open(null),e},t.prototype.feed=function(t){return new a(t,this)},t.prototype.absPath=function(t){return("/apps/"+this.appId+"/"+t).replace(/\/+/g,"/").replace(/\/+$/,"")},t}();e.App=p}])});